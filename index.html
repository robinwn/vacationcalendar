<!DOCTYPE html>
<!--
================================================================================
Calendar Application with Holidays & Vacation Planning
================================================================================

Author: Robin Windels
Email: robin.windels@gov.bc.ca
Created: 2025
Version: 1.0

Description:
A calendar application for managing vacation days, flex days, and 
statutory holidays for British Columbia.
It runs fully locally, no server required.  Run it from Github or
download it and doubleclick.

Features:
- Dynamic BC statutory holiday calculation
- Interactive vacation day planning
- Automated flex day generation with customizable schedules
- Local storage with JSON import/export
- Responsive design for desktop and mobile

================================================================================
License: GNU General Public License v3.0
================================================================================

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program. If not, see <https://www.gnu.org/licenses/>.

================================================================================

For updates, documentation, and source code, visit:
[https://github.com/robinwn/vacationcalendar]

================================================================================
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 Calendar with Holidays & Vacation</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .year-title {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .current-date {
            font-size: 1.2rem;
            color: #666;
            font-weight: 500;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
            align-items: center;
        }

        .control-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            padding: 15px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 15px;
            border: 2px solid rgba(102, 126, 234, 0.2);
        }

        .control-group-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #667eea;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-right: 10px;
            white-space: nowrap;
        }

        .nav-btn, .mode-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            white-space: nowrap;
        }

        .nav-btn:hover, .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .mode-btn.active {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .vacation-btn {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }

        .flex-btn {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
        }

        .clear-btn {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
        }

        .data-btn {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .legend-today { background: linear-gradient(45deg, #667eea, #764ba2); }
        .legend-holiday { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .legend-vacation { background: linear-gradient(45deg, #f39c12, #e67e22); }
        .legend-flex { background: linear-gradient(45deg, #9b59b6, #8e44ad); }
        .legend-weekend { background: linear-gradient(45deg, #95a5a6, #7f8c8d); }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .month-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .month-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .month-header {
            text-align: center;
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .calendar-table {
            width: 100%;
            border-collapse: collapse;
        }

        .calendar-table th,
        .calendar-table td {
            width: 14.28%;
            height: 40px;
            text-align: center;
            vertical-align: middle;
            font-size: 0.9rem;
            position: relative;
        }

        .calendar-table th {
            font-weight: 600;
            color: #666;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .calendar-table td {
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .calendar-table td:hover {
            transform: scale(1.1);
            z-index: 10;
        }

        .calendar-table td.other-month {
            color: #ccc;
        }

        .calendar-table td.holiday {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            font-weight: bold;
        }

        .calendar-table td.vacation {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
            font-weight: bold;
        }

        .calendar-table td.flex {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            color: white;
            font-weight: bold;
        }

        .calendar-table td.weekend:not(.holiday):not(.vacation):not(.flex) {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
            color: white;
        }

        .calendar-table td.holiday:hover {
            background: linear-gradient(45deg, #c0392b, #a93226);
        }

        .calendar-table td.vacation:hover {
            background: linear-gradient(45deg, #e67e22, #d35400);
        }

        .calendar-table td.flex:hover {
            background: linear-gradient(45deg, #8e44ad, #7d3c98);
        }

        .date-tooltip {
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 20;
        }

        .calendar-table td:hover .date-tooltip {
            opacity: 1;
        }

        .vacation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #666;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
            padding: 15px 25px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            font-weight: 500;
            max-width: 300px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.error {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        @media (max-width: 768px) {
            .calendar-grid {
                grid-template-columns: 1fr;
            }
            
            .year-title {
                font-size: 2rem;
            }
            
            .container {
                padding: 20px;
            }
            
            .controls {
                gap: 15px;
            }

            .control-group {
                flex-direction: column;
                align-items: center;
                padding: 10px;
            }

            .control-group-title {
                margin-right: 0;
                margin-bottom: 5px;
            }
            
            .legend {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            
            .stats {
                flex-direction: column;
                gap: 15px;
            }

            .nav-btn, .mode-btn {
                font-size: 0.8rem;
                padding: 8px 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="year-title" id="yearTitle">2025</h1>
            <p class="current-date" id="currentDate"></p>
        </div>

        <div class="stats" id="stats">
            <div class="stat-item">
                <div class="stat-number" id="holidayCount">0</div>
                <div class="stat-label">Holidays</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="vacationCount">0</div>
                <div class="stat-label">Vacation Days</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="flexCount">0</div>
                <div class="stat-label">Flex Days</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="workingDays">0</div>
                <div class="stat-label">Working Days</div>
            </div>
        </div>

        <div class="controls">
            <!-- Navigation Controls -->
            <div class="control-group">
                <span class="control-group-title">Navigation</span>
                <button class="nav-btn" onclick="Calendar.changeYear(-1)">← Previous Year</button>
                <button class="nav-btn" onclick="Calendar.goToCurrentYear()">Current Year</button>
                <button class="nav-btn" onclick="Calendar.changeYear(1)">Next Year →</button>
            </div>

            <!-- Vacation Management -->
            <div class="control-group">
                <span class="control-group-title">Vacation</span>
                <button class="mode-btn" id="vacationMode" onclick="AppState.toggleVacationMode()">Vacation Mode: OFF</button>
                <button class="nav-btn vacation-btn" onclick="Vacation.openPlanModal()">Plan Vacation</button>
                <button class="nav-btn clear-btn" onclick="Vacation.clear()">Clear Vacations</button>
            </div>

            <!-- Flex Day Management -->
            <div class="control-group">
                <span class="control-group-title">Flex Days</span>
                <button class="mode-btn" id="flexMode" onclick="AppState.toggleFlexMode()">Flex Mode: OFF</button>
                <button class="nav-btn flex-btn" onclick="FlexDays.generate()">Generate Flex Days</button>
                <button class="nav-btn flex-btn" onclick="FlexDays.openSettingsModal()">Flex Settings</button>
                <button class="nav-btn clear-btn" onclick="FlexDays.clear()">Clear Flex Days</button>
            </div>

            <!-- Data Management -->
            <div class="control-group">
                <span class="control-group-title">Data</span>
                <button class="nav-btn data-btn" onclick="DataManager.exportToJSON()">Export JSON</button>
                <button class="nav-btn data-btn" onclick="document.getElementById('fileInput').click()">Load from JSON</button>
                <button class="nav-btn clear-btn" onclick="Storage.clear()">Clear Saved Data</button>
            </div>
        </div>

        <p style="text-align: center; color: #667eea; font-size: 0.9rem; margin-bottom: 15px;">
            📱 <strong>Source Code:</strong> <a href="https://github.com/robinwn/vacationcalendar" target="_blank" style="color: #667eea; text-decoration: none; font-weight: 600;">github.com/robinwn/vacationcalendar</a>
        </p>

        <p style="text-align: center; color: #666; font-size: 0.9rem; margin-bottom: 20px;">
            💡 <strong>Tip:</strong> In Vacation Mode, click weekdays to mark vacation days. Holidays, flex days, and weekends are not allowed.
        </p>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color legend-today"></div>
                <span>Today</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-holiday"></div>
                <span>Statutory Holiday</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-vacation"></div>
                <span>Vacation Day</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-flex"></div>
                <span>Flex Day</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-weekend"></div>
                <span>Weekend</span>
            </div>
        </div>

        <div class="calendar-grid" id="calendarGrid">
            <!-- Calendar months will be generated here -->
        </div>

        <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="DataManager.importFromJSON(event)">
    </div>

    <script>
        // ===== CONFIGURATION & CONSTANTS =====
        const CONFIG = {
            STORAGE_KEY: 'calendar-data',
            VERSION: '1.0',
            MAX_SEARCH_DAYS: 10,
            DEFAULT_FLEX_PERIOD: 14,
            NOTIFICATION_DURATION: 4000
        };

        const MONTH_NAMES = [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
        ];
        
        const DAY_NAMES = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        // Holiday calculation constants
        const HOLIDAY_CONFIG = {
            FAMILY_DAY_START: 2013,
            TRUTH_RECONCILIATION_START: 2021
        };

        const MONTHS = {
            JANUARY: 0,
            FEBRUARY: 1,
            MARCH: 2,
            APRIL: 3,
            MAY: 4,
            JUNE: 5,
            JULY: 6,
            AUGUST: 7,
            SEPTEMBER: 8,
            OCTOBER: 9,
            NOVEMBER: 10,
            DECEMBER: 11
        };

        const DAYS = {
            SUNDAY: 0,
            MONDAY: 1,
            TUESDAY: 2,
            WEDNESDAY: 3,
            THURSDAY: 4,
            FRIDAY: 5,
            SATURDAY: 6
        };

        const ONEDAY = 24 * 60 * 60 * 1000;

        // ===== HOLIDAY CALCULATION FUNCTIONS =====
        const HolidayCalculator = {
            getNthWeekdayOfMonth(year, month, dayOfWeek, n) {
                const firstDay = new Date(year, month, 1).getDay();
                let daysToAdd = (dayOfWeek - firstDay + 7) % 7;
                
                if (daysToAdd < 0) {
                    daysToAdd += 7;
                }
                
                const resultDate = new Date(year, month, 1 + daysToAdd + (n - 1) * 7);
                
                // Validate that we're still in the same month
                if (resultDate.getMonth() !== month) {
                    throw new Error(`Cannot find ${n}th weekday in month`);
                }
                
                return resultDate;
            },

            getEasterSunday(year) {
                let a = year % 19;
                let b = Math.floor(year / 100);
                let c = year % 100;
                let d = Math.floor(b / 4);
                let e = b % 4;
                let f = Math.floor((b + 8) / 25);
                let g = Math.floor((b - f + 1) / 3);
                let h = (19 * a + b - d - g + 15) % 30;
                let i = Math.floor(c / 4);
                let k = c % 4;
                let l = (32 + 2 * e + 2 * i - h - k) % 7;
                let m = Math.floor((a + 11 * h + 22 * l) / 451);

                const month = Math.floor((h + l - 7 * m + 114) / 31);
                const day = ((h + l - 7 * m + 114) % 31) + 1;

                return new Date(year, month - 1, day);
            },

            getGoodFriday(year) {
                const easterSunday = this.getEasterSunday(year);
                return new Date(easterSunday.getTime() - 2 * ONEDAY);
            },

            getEasterMonday(year) {
                const easterSunday = this.getEasterSunday(year);
                return new Date(easterSunday.getTime() + ONEDAY);
            },

            getVictoriaDay(year) {
                // Victoria Day is the Monday on or before May 24th
                const may24 = new Date(year, MONTHS.MAY, 24);
                const dayOfWeek = may24.getDay();
                const daysToSubtract = (dayOfWeek - DAYS.MONDAY + 7) % 7;
                
                return new Date(may24.getTime() - daysToSubtract * ONEDAY);
            },

            moveToMondayIfWeekend(date) {
                const dayOfWeek = date.getDay();
                if (dayOfWeek === DAYS.SATURDAY) {
                    return new Date(date.getTime() + 2 * ONEDAY);
                } else if (dayOfWeek === DAYS.SUNDAY) {
                    return new Date(date.getTime() + 1 * ONEDAY);
                }
                return null;
            },

            moveBoxingDayIfWeekend(boxingDay, christmasSubstitute) {
                const boxingDayOfWeek = boxingDay.getDay();
                
                if (christmasSubstitute) {
                    // If Christmas was moved, Boxing Day moves to the day after Christmas substitute
                    return new Date(christmasSubstitute.getTime() + 1 * ONEDAY);
                } else if (boxingDayOfWeek === DAYS.SATURDAY) {
                    // Boxing Day on Saturday moves to Monday
                    return new Date(boxingDay.getTime() + 2 * ONEDAY);
                } else if (boxingDayOfWeek === DAYS.SUNDAY) {
                    // Boxing Day on Sunday moves to Tuesday
                    return new Date(boxingDay.getTime() + 2 * ONEDAY);
                }
                
                return null;
            },

            getStatutoryHolidays(year) {
                const holidays = {};

                try {
                    // New Year's Day
                    const newYearsDay = new Date(year, MONTHS.JANUARY, 1);
                    const substituteNewYearsDay = this.moveToMondayIfWeekend(newYearsDay);
                    const newYearsDate = substituteNewYearsDay || newYearsDay;
                    holidays[DateUtils.getDateKey(newYearsDate.getFullYear(), newYearsDate.getMonth(), newYearsDate.getDate())] = 'New Year\'s Day';

                    // Family Day (third Monday in February, started in 2013)
                    if (year >= HOLIDAY_CONFIG.FAMILY_DAY_START) {
                        const familyDay = this.getNthWeekdayOfMonth(year, MONTHS.FEBRUARY, DAYS.MONDAY, 3);
                        holidays[DateUtils.getDateKey(familyDay.getFullYear(), familyDay.getMonth(), familyDay.getDate())] = 'Family Day';
                    }

                    // Good Friday
                    const goodFriday = this.getGoodFriday(year);
                    holidays[DateUtils.getDateKey(goodFriday.getFullYear(), goodFriday.getMonth(), goodFriday.getDate())] = 'Good Friday';

                    // Easter Monday
                    const easterMonday = this.getEasterMonday(year);
                    holidays[DateUtils.getDateKey(easterMonday.getFullYear(), easterMonday.getMonth(), easterMonday.getDate())] = 'Easter Monday';

                    // Victoria Day
                    const victoriaDay = this.getVictoriaDay(year);
                    holidays[DateUtils.getDateKey(victoriaDay.getFullYear(), victoriaDay.getMonth(), victoriaDay.getDate())] = 'Victoria Day';

                    // Canada Day
                    const canadaDay = new Date(year, MONTHS.JULY, 1);
                    const substituteCanadaDay = this.moveToMondayIfWeekend(canadaDay);
                    const canadaDayDate = substituteCanadaDay || canadaDay;
                    holidays[DateUtils.getDateKey(canadaDayDate.getFullYear(), canadaDayDate.getMonth(), canadaDayDate.getDate())] = 'Canada Day';

                    // BC Day (first Monday in August)
                    const bcDay = this.getNthWeekdayOfMonth(year, MONTHS.AUGUST, DAYS.MONDAY, 1);
                    holidays[DateUtils.getDateKey(bcDay.getFullYear(), bcDay.getMonth(), bcDay.getDate())] = 'B.C. Day';

                    // Labour Day (first Monday in September)
                    const labourDay = this.getNthWeekdayOfMonth(year, MONTHS.SEPTEMBER, DAYS.MONDAY, 1);
                    holidays[DateUtils.getDateKey(labourDay.getFullYear(), labourDay.getMonth(), labourDay.getDate())] = 'Labour Day';

                    // Truth and Reconciliation Day (started in 2021)
                    if (year >= HOLIDAY_CONFIG.TRUTH_RECONCILIATION_START) {
                        const truthAndReconciliationDay = new Date(year, MONTHS.SEPTEMBER, 30);
                        const substituteTruthAndReconciliationDay = this.moveToMondayIfWeekend(truthAndReconciliationDay);
                        const truthAndReconciliationDate = substituteTruthAndReconciliationDay || truthAndReconciliationDay;
                        holidays[DateUtils.getDateKey(truthAndReconciliationDate.getFullYear(), truthAndReconciliationDate.getMonth(), truthAndReconciliationDate.getDate())] = 'Truth & Reconciliation Day';
                    }

                    // Thanksgiving Day (second Monday in October)
                    const thanksgivingDay = this.getNthWeekdayOfMonth(year, MONTHS.OCTOBER, DAYS.MONDAY, 2);
                    holidays[DateUtils.getDateKey(thanksgivingDay.getFullYear(), thanksgivingDay.getMonth(), thanksgivingDay.getDate())] = 'Thanksgiving Day';

                    // Remembrance Day
                    const remembranceDay = new Date(year, MONTHS.NOVEMBER, 11);
                    const substituteRemembranceDay = this.moveToMondayIfWeekend(remembranceDay);
                    const remembranceDayDate = substituteRemembranceDay || remembranceDay;
                    holidays[DateUtils.getDateKey(remembranceDayDate.getFullYear(), remembranceDayDate.getMonth(), remembranceDayDate.getDate())] = 'Remembrance Day';

                    // Christmas Day
                    const christmasDay = new Date(year, MONTHS.DECEMBER, 25);
                    const substituteChristmasDay = this.moveToMondayIfWeekend(christmasDay);
                    const christmasDayDate = substituteChristmasDay || christmasDay;
                    holidays[DateUtils.getDateKey(christmasDayDate.getFullYear(), christmasDayDate.getMonth(), christmasDayDate.getDate())] = 'Christmas Day';

                    // Boxing Day
                    const boxingDay = new Date(year, MONTHS.DECEMBER, 26);
                    const substituteBoxingDay = this.moveBoxingDayIfWeekend(boxingDay, substituteChristmasDay);
                    const boxingDayDate = substituteBoxingDay || boxingDay;
                    holidays[DateUtils.getDateKey(boxingDayDate.getFullYear(), boxingDayDate.getMonth(), boxingDayDate.getDate())] = 'Boxing Day';

                } catch (error) {
                    console.error(`Error calculating holidays for year ${year}:`, error);
                }

                return holidays;
            }
        };
        const AppState = {
            currentYear: 2025,
            vacationMode: false,
            flexMode: false,
            vacationDays: {},
            flexDays: {},
            flexSettings: {
                startDate: '2025-01-03',
                periodDays: 14
            },
            today: new Date(),

            // State management methods
            setVacationDay(dateKey, name) {
                this.vacationDays[dateKey] = name;
                Storage.save();
            },

            removeVacationDay(dateKey) {
                delete this.vacationDays[dateKey];
                Storage.save();
            },

            setFlexDay(dateKey, name) {
                this.flexDays[dateKey] = name;
                Storage.save();
            },

            removeFlexDay(dateKey) {
                delete this.flexDays[dateKey];
                Storage.save();
            },

            toggleVacationMode() {
                this.vacationMode = !this.vacationMode;
                this.flexMode = false;
                UI.updateModeButtons();
            },

            toggleFlexMode() {
                this.flexMode = !this.flexMode;
                this.vacationMode = false;
                UI.updateModeButtons();
            },

            setYear(year) {
                this.currentYear = year;
                document.getElementById('yearTitle').textContent = year;
            }
        };

        // ===== UTILITY FUNCTIONS =====
        const DateUtils = {
            getDaysInMonth(year, month) {
                return new Date(year, month + 1, 0).getDate();
            },

            getFirstDayOfMonth(year, month) {
                return new Date(year, month, 1).getDay();
            },

            getDateKey(year, month, day) {
                return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            },

            isWeekend(year, month, day) {
                const date = new Date(year, month, day);
                const dayOfWeek = date.getDay();
                return dayOfWeek === 0 || dayOfWeek === 6;
            },

            isHoliday(year, month, day) {
                const dateKey = this.getDateKey(year, month, day);
                const yearHolidays = HolidayCalculator.getStatutoryHolidays(year);
                return yearHolidays[dateKey];
            },

            getHolidayName(year, month, day) {
                const dateKey = this.getDateKey(year, month, day);
                const yearHolidays = HolidayCalculator.getStatutoryHolidays(year);
                return yearHolidays[dateKey];
            },

            isVacation(year, month, day) {
                const dateKey = this.getDateKey(year, month, day);
                return AppState.vacationDays[dateKey];
            },

            isFlex(year, month, day) {
                const dateKey = this.getDateKey(year, month, day);
                return AppState.flexDays[dateKey];
            },

            isToday(year, month, day) {
                return year === AppState.today.getFullYear() && 
                       month === AppState.today.getMonth() && 
                       day === AppState.today.getDate();
            }
        };

        // ===== UI UTILITIES =====
        const UI = {
            showNotification(message, isError = false) {
                const existingNotification = document.querySelector('.notification');
                if (existingNotification) {
                    existingNotification.remove();
                }

                const notification = document.createElement('div');
                notification.className = `notification ${isError ? 'error' : ''}`;
                notification.textContent = message;

                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.classList.add('show');
                }, 100);

                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, CONFIG.NOTIFICATION_DURATION);
            },

            updateStats() {
                const yearHolidays = HolidayCalculator.getStatutoryHolidays(AppState.currentYear);
                const holidayCount = Object.keys(yearHolidays).length;
                
                const vacationCount = Object.keys(AppState.vacationDays).filter(key => 
                    key.startsWith(AppState.currentYear.toString())).length;
                
                const flexCount = Object.keys(AppState.flexDays).filter(key => 
                    key.startsWith(AppState.currentYear.toString())).length;
                
                const totalDays = new Date(AppState.currentYear, 11, 31).getDate() === 31 ? 
                    (AppState.currentYear % 4 === 0 ? 366 : 365) : 365;
                const weekends = Math.floor(totalDays / 7) * 2;
                const workingDays = totalDays - weekends - holidayCount - vacationCount - flexCount;
                
                document.getElementById('holidayCount').textContent = holidayCount;
                document.getElementById('vacationCount').textContent = vacationCount;
                document.getElementById('flexCount').textContent = flexCount;
                document.getElementById('workingDays').textContent = Math.max(0, workingDays);
            },

            updateModeButtons() {
                const vacationBtn = document.getElementById('vacationMode');
                const flexBtn = document.getElementById('flexMode');
                
                vacationBtn.textContent = `Vacation Mode: ${AppState.vacationMode ? 'ON' : 'OFF'}`;
                vacationBtn.classList.toggle('active', AppState.vacationMode);
                
                flexBtn.textContent = `Flex Mode: ${AppState.flexMode ? 'ON' : 'OFF'}`;
                flexBtn.classList.toggle('active', AppState.flexMode);
            },

            updateCurrentDate() {
                const options = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                };
                document.getElementById('currentDate').textContent = 
                    `Today is ${AppState.today.toLocaleDateString('en-US', options)}`;
            },

            createTooltip(cell, year, month, day) {
                const existingTooltip = cell.querySelector('.date-tooltip');
                if (existingTooltip) {
                    existingTooltip.remove();
                }

                const holiday = DateUtils.getHolidayName(year, month, day);
                const vacation = DateUtils.isVacation(year, month, day);
                const flex = DateUtils.isFlex(year, month, day);
                const weekend = DateUtils.isWeekend(year, month, day);

                let tooltipText = '';
                if (holiday) tooltipText = holiday;
                else if (vacation) tooltipText = vacation;
                else if (flex) tooltipText = flex;
                else if (weekend) tooltipText = 'Weekend';

                if (tooltipText) {
                    const tooltip = document.createElement('div');
                    tooltip.className = 'date-tooltip';
                    tooltip.textContent = tooltipText;
                    cell.appendChild(tooltip);
                }
            }
        };

        // ===== DATA STORAGE =====
        const Storage = {
            save() {
                try {
                    const calendarData = {
                        vacationDays: AppState.vacationDays,
                        flexDays: AppState.flexDays,
                        flexSettings: AppState.flexSettings,
                        currentYear: AppState.currentYear,
                        lastSaved: new Date().toISOString(),
                        version: CONFIG.VERSION
                    };
                    
                    localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(calendarData));
                } catch (error) {
                    console.error('Error saving to localStorage:', error);
                    UI.showNotification('Failed to save data locally', true);
                }
            },

            load() {
                try {
                    const savedData = localStorage.getItem(CONFIG.STORAGE_KEY);
                    if (!savedData) return false;

                    const calendarData = JSON.parse(savedData);
                    
                    if (calendarData.vacationDays) {
                        AppState.vacationDays = calendarData.vacationDays;
                    }
                    
                    if (calendarData.flexDays) {
                        AppState.flexDays = calendarData.flexDays;
                    }
                    
                    if (calendarData.flexSettings) {
                        AppState.flexSettings = calendarData.flexSettings;
                    }
                    
                    if (calendarData.currentYear) {
                        AppState.setYear(calendarData.currentYear);
                    }
                    
                    const vacationCount = Object.keys(AppState.vacationDays).length;
                    const flexCount = Object.keys(AppState.flexDays).length;
                    
                    if (vacationCount > 0 || flexCount > 0) {
                        UI.showNotification(`Calendar data restored! Vacation: ${vacationCount} | Flex: ${flexCount}`);
                    }
                    
                    return true;
                } catch (error) {
                    console.error('Error loading from localStorage:', error);
                    UI.showNotification('Failed to load saved data', true);
                    return false;
                }
            },

            clear() {
                try {
                    localStorage.removeItem(CONFIG.STORAGE_KEY);
                    UI.showNotification('Saved calendar data cleared');
                } catch (error) {
                    console.error('Error clearing localStorage:', error);
                }
            }
        };

        // ===== CALENDAR GENERATION =====
        const Calendar = {
            generate(year) {
                this.clearGrid();
                for (let month = 0; month < 12; month++) {
                    const monthCalendar = this.createMonth(year, month);
                    this.appendToGrid(monthCalendar);
                }
                UI.updateStats();
            },

            clearGrid() {
                const calendarGrid = document.getElementById('calendarGrid');
                calendarGrid.innerHTML = '';
            },

            appendToGrid(monthElement) {
                const calendarGrid = document.getElementById('calendarGrid');
                calendarGrid.appendChild(monthElement);
            },

            createMonth(year, month) {
                const monthContainer = document.createElement('div');
                monthContainer.className = 'month-container';

                const monthHeader = this.createMonthHeader(month);
                const table = this.createMonthTable(year, month);

                monthContainer.appendChild(monthHeader);
                monthContainer.appendChild(table);
                return monthContainer;
            },

            createMonthHeader(month) {
                const monthHeader = document.createElement('div');
                monthHeader.className = 'month-header';
                monthHeader.textContent = MONTH_NAMES[month];
                return monthHeader;
            },

            createMonthTable(year, month) {
                const table = document.createElement('table');
                table.className = 'calendar-table';

                const headerRow = this.createHeaderRow();
                table.appendChild(headerRow);

                const daysInMonth = DateUtils.getDaysInMonth(year, month);
                const firstDay = DateUtils.getFirstDayOfMonth(year, month);
                const daysInPrevMonth = DateUtils.getDaysInMonth(year, month - 1);

                let date = 1;
                let nextMonthDate = 1;

                for (let week = 0; week < 6; week++) {
                    const row = document.createElement('tr');
                    
                    for (let day = 0; day < 7; day++) {
                        const cell = document.createElement('td');
                        const cellDate = week * 7 + day;
                        
                        if (cellDate < firstDay) {
                            cell.textContent = daysInPrevMonth - firstDay + cellDate + 1;
                            cell.className = 'other-month';
                        } else if (date <= daysInMonth) {
                            cell.textContent = date;
                            
                            const currentDate = date;
                            this.applyCellStyles(cell, year, month, currentDate);
                            this.attachCellEvents(cell, year, month, currentDate);
                            
                            date++;
                        } else {
                            cell.textContent = nextMonthDate;
                            cell.className = 'other-month';
                            nextMonthDate++;
                        }
                        
                        row.appendChild(cell);
                    }
                    
                    table.appendChild(row);
                    
                    if (date > daysInMonth) {
                        break;
                    }
                }

                return table;
            },

            createHeaderRow() {
                const headerRow = document.createElement('tr');
                DAY_NAMES.forEach(day => {
                    const th = document.createElement('th');
                    th.textContent = day;
                    headerRow.appendChild(th);
                });
                return headerRow;
            },

            applyCellStyles(cell, year, month, day) {
                const holiday = DateUtils.isHoliday(year, month, day);
                const vacation = DateUtils.isVacation(year, month, day);
                const flex = DateUtils.isFlex(year, month, day);
                const weekend = DateUtils.isWeekend(year, month, day);
                const isToday = DateUtils.isToday(year, month, day);
                
                if (holiday) {
                    cell.className = 'holiday';
                } else if (vacation) {
                    cell.className = 'vacation';
                } else if (flex) {
                    cell.className = 'flex';
                } else if (weekend) {
                    cell.className = 'weekend';
                }
                
                if (isToday) {
                    cell.style.border = 'none';
                    cell.style.borderRadius = '8px';
                    cell.style.fontWeight = 'bold';
                    cell.style.fontSize = '1.2em';
                    cell.style.boxShadow = 'inset 0 0 0 4px #667eea, 0 0 15px rgba(102, 126, 234, 0.5)';
                    cell.style.position = 'relative';
                    cell.style.zIndex = '10';
                }

                UI.createTooltip(cell, year, month, day);
            },

            attachCellEvents(cell, year, month, day) {
                cell.addEventListener('click', () => this.handleDateClick(year, month, day, cell));
            },

            handleDateClick(year, month, day, cell) {
                if (cell.classList.contains('other-month')) return;
                
                const dateKey = DateUtils.getDateKey(year, month, day);
                const holiday = DateUtils.isHoliday(year, month, day);
                const flex = DateUtils.isFlex(year, month, day);
                const weekend = DateUtils.isWeekend(year, month, day);
                
                if (AppState.vacationMode) {
                    if (holiday || flex || weekend) {
                        let dayType = '';
                        if (holiday) dayType = 'statutory holiday';
                        else if (flex) dayType = 'flex day';
                        else if (weekend) dayType = 'weekend';
                        
                        UI.showNotification(`Cannot mark vacation on ${dayType}`, true);
                        return;
                    }
                    
                    if (AppState.vacationDays[dateKey]) {
                        AppState.removeVacationDay(dateKey);
                        cell.classList.remove('vacation');
                        UI.showNotification('Vacation day removed');
                    } else {
                        AppState.setVacationDay(dateKey, 'Vacation Day');
                        cell.classList.add('vacation');
                        UI.showNotification('Vacation day added');
                    }
                    
                    UI.createTooltip(cell, year, month, day);
                    UI.updateStats();
                } else if (AppState.flexMode) {
                    if (holiday || weekend) {
                        let dayType = '';
                        if (holiday) dayType = 'statutory holiday';
                        else if (weekend) dayType = 'weekend';
                        
                        UI.showNotification(`Cannot mark flex day on ${dayType}`, true);
                        return;
                    }
                    
                    if (AppState.flexDays[dateKey]) {
                        AppState.removeFlexDay(dateKey);
                        cell.classList.remove('flex');
                        UI.showNotification('Flex day removed');
                    } else {
                        AppState.setFlexDay(dateKey, 'Flex Day');
                        cell.classList.add('flex');
                        if (AppState.vacationDays[dateKey]) {
                            AppState.removeVacationDay(dateKey);
                            cell.classList.remove('vacation');
                            UI.showNotification('Flex day added (replaced vacation day)');
                        } else {
                            UI.showNotification('Flex day added');
                        }
                    }
                    
                    UI.createTooltip(cell, year, month, day);
                    UI.updateStats();
                }
            },

            changeYear(delta) {
                AppState.setYear(AppState.currentYear + delta);
                this.generate(AppState.currentYear);
            },

            goToCurrentYear() {
                AppState.setYear(AppState.today.getFullYear());
                this.generate(AppState.currentYear);
            }
        };

        // ===== FLEX DAY MANAGEMENT =====
        const FlexDays = {
            generate() {
                // Clear existing flex days for current year
                Object.keys(AppState.flexDays).forEach(key => {
                    if (key.startsWith(AppState.currentYear.toString())) {
                        delete AppState.flexDays[key];
                    }
                });
                
                const baseStartDate = new Date(AppState.flexSettings.startDate + 'T12:00:00');
                const period = AppState.flexSettings.periodDays;
                
                let addedDays = 0;
                let movedDays = 0;
                let replacedVacations = 0;
                
                let flexDate = new Date(baseStartDate);
                
                // Step to get into target year
                while (flexDate.getFullYear() < AppState.currentYear) {
                    flexDate.setDate(flexDate.getDate() + period);
                }
                while (flexDate.getFullYear() > AppState.currentYear) {
                    flexDate.setDate(flexDate.getDate() - period);
                }
                
                // Generate all flex days for current year
                while (flexDate.getFullYear() === AppState.currentYear) {
                    let finalFlexDate = new Date(flexDate);
                    
                    let year = finalFlexDate.getFullYear();
                    let month = finalFlexDate.getMonth();
                    let day = finalFlexDate.getDate();
                    
                    if (DateUtils.isHoliday(year, month, day)) {
                        let foundWorkingDay = false;
                        let searchAttempts = 0;
                        
                        while (!foundWorkingDay && searchAttempts < CONFIG.MAX_SEARCH_DAYS) {
                            finalFlexDate.setDate(finalFlexDate.getDate() + 1);
                            searchAttempts++;
                            
                            year = finalFlexDate.getFullYear();
                            month = finalFlexDate.getMonth();
                            day = finalFlexDate.getDate();
                            
                            if (!DateUtils.isHoliday(year, month, day) && !DateUtils.isWeekend(year, month, day)) {
                                foundWorkingDay = true;
                                movedDays++;
                            }
                        }
                    }
                    
                    if (finalFlexDate.getFullYear() === AppState.currentYear) {
                        const finalDateKey = finalFlexDate.toISOString().split('T')[0];
                        
                        if (AppState.vacationDays[finalDateKey]) {
                            delete AppState.vacationDays[finalDateKey];
                            replacedVacations++;
                        }
                        
                        AppState.flexDays[finalDateKey] = 'Flex Day';
                        addedDays++;
                    }
                    
                    flexDate.setDate(flexDate.getDate() + period);
                }
                
                Calendar.generate(AppState.currentYear);
                Storage.save();
                
                let message = `Generated ${addedDays} flex days`;
                if (movedDays > 0) {
                    message += ` (${movedDays} moved for holidays)`;
                }
                if (replacedVacations > 0) {
                    message += ` (${replacedVacations} replaced vacation days)`;
                }
                UI.showNotification(message);
            },

            clear() {
                AppState.flexDays = {};
                Calendar.generate(AppState.currentYear);
                Storage.save();
                UI.showNotification('All flex days cleared');
            },

            openSettingsModal() {
                const existingModal = document.getElementById('flexSettingsModal');
                if (existingModal) {
                    existingModal.remove();
                }

                const modalHTML = `
                    <div class="vacation-modal" id="flexSettingsModal" style="display: flex;">
                        <div class="modal-content">
                            <div class="modal-header">Flex Day Settings</div>
                            <div class="form-group">
                                <label for="flexStartDate">Start Date:</label>
                                <input type="date" id="flexStartDate" value="${AppState.flexSettings.startDate}">
                                <small style="color: #666; font-size: 0.8rem;">The base date from which all flex days are calculated</small>
                            </div>
                            <div class="form-group">
                                <label for="flexPeriod">Period (days):</label>
                                <input type="number" id="flexPeriod" value="${AppState.flexSettings.periodDays}" min="1" max="365">
                                <small style="color: #666; font-size: 0.8rem;">Number of days between flex days (e.g., 14 for bi-weekly)</small>
                            </div>
                            <div class="modal-buttons">
                                <button class="btn btn-secondary" onclick="FlexDays.closeSettingsModal()">Cancel</button>
                                <button class="btn btn-primary" onclick="FlexDays.saveSettings()">Save Settings</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);

                const modal = document.getElementById('flexSettingsModal');
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        FlexDays.closeSettingsModal();
                    }
                });
            },

            closeSettingsModal() {
                const modal = document.getElementById('flexSettingsModal');
                if (modal) {
                    modal.remove();
                }
            },

            saveSettings() {
                const startDate = document.getElementById('flexStartDate').value;
                const period = parseInt(document.getElementById('flexPeriod').value);
                
                if (!startDate) {
                    UI.showNotification('Please select a start date.', true);
                    return;
                }
                
                if (!period || period < 1) {
                    UI.showNotification('Please enter a valid period (1 or more days).', true);
                    return;
                }
                
                AppState.flexSettings.startDate = startDate;
                AppState.flexSettings.periodDays = period;
                
                this.closeSettingsModal();
                Storage.save();
                
                UI.showNotification(`Flex settings updated! Start: ${startDate}, Period: ${period} days`);
            }
        };

        // ===== VACATION MANAGEMENT =====
        const Vacation = {
            openPlanModal() {
                const existingModal = document.getElementById('vacationModal');
                if (existingModal) {
                    existingModal.remove();
                }

                const modalHTML = `
                    <div class="vacation-modal" id="vacationModal" style="display: flex;">
                        <div class="modal-content">
                            <div class="modal-header">Plan Your Vacation</div>
                            <div class="form-group">
                                <label for="vacationStart">Start Date:</label>
                                <input type="date" id="vacationStart">
                            </div>
                            <div class="form-group">
                                <label for="vacationEnd">End Date:</label>
                                <input type="date" id="vacationEnd">
                            </div>
                            <div class="form-group">
                                <label for="vacationName">Vacation Name (optional):</label>
                                <input type="text" id="vacationName" placeholder="e.g., Summer Vacation, Beach Trip">
                            </div>
                            <div class="modal-buttons">
                                <button class="btn btn-secondary" onclick="Vacation.closePlanModal()">Cancel</button>
                                <button class="btn btn-primary" onclick="Vacation.addVacation()">Add Vacation</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);

                const modal = document.getElementById('vacationModal');
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        Vacation.closePlanModal();
                    }
                });
            },

            closePlanModal() {
                const modal = document.getElementById('vacationModal');
                if (modal) {
                    modal.remove();
                }
            },

            addVacation() {
                const startDate = document.getElementById('vacationStart').value;
                const endDate = document.getElementById('vacationEnd').value;
                const vacationName = document.getElementById('vacationName').value || 'Vacation Day';
                
                if (!startDate || !endDate) {
                    UI.showNotification('Please select both start and end dates.', true);
                    return;
                }
                
                const start = new Date(startDate + 'T12:00:00'); // Add time to avoid timezone issues
                const end = new Date(endDate + 'T12:00:00');
                
                if (start > end) {
                    UI.showNotification('Start date must be before end date.', true);
                    return;
                }
                
                let addedDays = 0;
                let skippedDays = 0;
                let skippedDetails = {
                    holidays: 0,
                    weekends: 0,
                    flexDays: 0
                };
                
                // Use a safer date iteration method
                const currentDate = new Date(start);
                while (currentDate <= end) {
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth();
                    const day = currentDate.getDate();
                    const dateKey = DateUtils.getDateKey(year, month, day);
                    
                    const holiday = DateUtils.isHoliday(year, month, day);
                    const flex = DateUtils.isFlex(year, month, day);
                    const weekend = DateUtils.isWeekend(year, month, day);
                    
                    // Only add vacation days on working days (not holidays, weekends, or flex days)
                    if (holiday) {
                        skippedDays++;
                        skippedDetails.holidays++;
                    } else if (weekend) {
                        skippedDays++;
                        skippedDetails.weekends++;
                    } else if (flex) {
                        skippedDays++;
                        skippedDetails.flexDays++;
                    } else {
                        // This is a working day - add vacation
                        AppState.vacationDays[dateKey] = vacationName;
                        addedDays++;
                    }
                    
                    // Move to next day
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                Calendar.generate(AppState.currentYear);
                this.closePlanModal();
                Storage.save();
                
                // Create detailed message about what was added and skipped
                let message = `Added ${addedDays} vacation days: ${vacationName}`;
                
                if (skippedDays > 0) {
                    let skippedParts = [];
                    if (skippedDetails.holidays > 0) {
                        skippedParts.push(`${skippedDetails.holidays} holiday${skippedDetails.holidays > 1 ? 's' : ''}`);
                    }
                    if (skippedDetails.weekends > 0) {
                        skippedParts.push(`${skippedDetails.weekends} weekend day${skippedDetails.weekends > 1 ? 's' : ''}`);
                    }
                    if (skippedDetails.flexDays > 0) {
                        skippedParts.push(`${skippedDetails.flexDays} flex day${skippedDetails.flexDays > 1 ? 's' : ''}`);
                    }
                    
                    message += ` (skipped ${skippedParts.join(', ')})`;
                }
                
                UI.showNotification(message);
            },

            clear() {
                AppState.vacationDays = {};
                Calendar.generate(AppState.currentYear);
                Storage.save();
                UI.showNotification('All vacation days cleared');
            }
        };

        // ===== IMPORT/EXPORT =====
        const DataManager = {
            exportToJSON() {
                try {
                    const currentDate = new Date().toISOString().split('T')[0];
                    
                    // Get current year vacation days and sort by date
                    const currentYearVacations = {};
                    const vacationEntries = Object.entries(AppState.vacationDays)
                        .filter(([date, name]) => date.startsWith(AppState.currentYear.toString()))
                        .sort(([a], [b]) => a.localeCompare(b)); // Sort by date key
                    
                    vacationEntries.forEach(([date, name]) => {
                        currentYearVacations[date] = name;
                    });
                    
                    // Get current year flex days and sort by date
                    const currentYearFlex = {};
                    const flexEntries = Object.entries(AppState.flexDays)
                        .filter(([date, name]) => date.startsWith(AppState.currentYear.toString()))
                        .sort(([a], [b]) => a.localeCompare(b)); // Sort by date key
                    
                    flexEntries.forEach(([date, name]) => {
                        currentYearFlex[date] = name;
                    });

                    const jsonData = {
                        metadata: {
                            exported_date: currentDate,
                            calendar_year: AppState.currentYear,
                            total_vacation_days: Object.keys(currentYearVacations).length,
                            total_flex_days: Object.keys(currentYearFlex).length,
                            export_format: "json",
                            version: CONFIG.VERSION
                        },
                        flex_settings: AppState.flexSettings,
                        vacation_days: currentYearVacations,
                        flex_days: currentYearFlex
                    };

                    const jsonContent = JSON.stringify(jsonData, null, 2);
                    this.createJSONModal(jsonContent);

                    UI.showNotification(`JSON generated for ${AppState.currentYear} | Vacation: ${Object.keys(currentYearVacations).length} | Flex: ${Object.keys(currentYearFlex).length}`);
                    
                } catch (error) {
                    console.error('Error generating JSON:', error);
                    UI.showNotification('Error generating JSON: ' + error.message, true);
                }
            },

            createJSONModal(jsonContent) {
                const existingModal = document.getElementById('jsonModal');
                if (existingModal) {
                    existingModal.remove();
                }

                const modalHTML = `
                    <div class="vacation-modal" id="jsonModal" style="display: flex;">
                        <div class="modal-content" style="max-width: 600px;">
                            <div class="modal-header">Export Calendar Data as JSON</div>
                            <p style="margin-bottom: 15px; color: #666;">Copy the JSON content below and save it to a .json file:</p>
                            <div class="form-group">
                                <label for="jsonOutput">JSON Content:</label>
                                <textarea id="jsonOutput" readonly style="width: 100%; height: 400px; font-family: monospace; font-size: 12px; resize: vertical; border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px;">${jsonContent}</textarea>
                            </div>
                            <div class="modal-buttons">
                                <button class="btn btn-primary" onclick="DataManager.copyJSONToClipboard()">Copy to Clipboard</button>
                                <button class="btn btn-secondary" onclick="DataManager.closeJSONModal()">Close</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);

                const modal = document.getElementById('jsonModal');
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        DataManager.closeJSONModal();
                    }
                });
            },

            closeJSONModal() {
                const modal = document.getElementById('jsonModal');
                if (modal) {
                    modal.remove();
                }
            },

            copyJSONToClipboard() {
                const jsonContent = document.getElementById('jsonOutput');
                if (jsonContent) {
                    jsonContent.select();
                    jsonContent.setSelectionRange(0, 99999);

                    try {
                        document.execCommand('copy');
                        UI.showNotification('JSON copied to clipboard! Save as calendar-data-' + AppState.currentYear + '.json');
                    } catch (err) {
                        UI.showNotification('Could not copy to clipboard. Please select all and copy manually.', true);
                    }
                }
            },

            importFromJSON(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const jsonContent = e.target.result;
                        const data = JSON.parse(jsonContent);
                        
                        if (data.flex_settings) {
                            AppState.flexSettings = data.flex_settings;
                        }
                        
                        if (data.vacation_days) {
                            AppState.vacationDays = { ...AppState.vacationDays, ...data.vacation_days };
                        }
                        
                        if (data.flex_days) {
                            const loadedYear = data.metadata && data.metadata.calendar_year ? data.metadata.calendar_year : AppState.currentYear;
                            Object.keys(AppState.flexDays).forEach(key => {
                                if (key.startsWith(loadedYear.toString())) {
                                    delete AppState.flexDays[key];
                                }
                            });
                            
                            AppState.flexDays = { ...AppState.flexDays, ...data.flex_days };
                        }
                        
                        if (data.metadata && data.metadata.calendar_year) {
                            AppState.setYear(data.metadata.calendar_year);
                        }
                        
                        Calendar.generate(AppState.currentYear);
                        
                        const vacationCount = Object.keys(data.vacation_days || {}).length;
                        const flexCount = Object.keys(data.flex_days || {}).length;
                        
                        Storage.save();
                        
                        UI.showNotification(`Calendar data loaded successfully! Vacation: ${vacationCount} | Flex: ${flexCount}`);
                        
                    } catch (error) {
                        UI.showNotification('Error loading JSON file: ' + error.message, true);
                    }
                };
                reader.readAsText(file);
                
                event.target.value = '';
            }
        };

        // ===== INITIALIZATION =====
        function initializeApp() {
            UI.updateCurrentDate();
            const dataLoaded = Storage.load();
            Calendar.generate(AppState.currentYear);
            
            if (!dataLoaded) {
                FlexDays.generate();
            }
        }

        // Start the app when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>